---
title: artisan 数据类型
---
# Artisan 数据类型

以下是 Artisan API 中最常用的数据类型。

---

## Artisan API 中使用的数据类型

| 类型                         | 描述                                                    |
| ---------------------------- | ------------------------------------------------------- |
| `AEGP_RenderLayerContextH` | 渲染请求时的状态信息，由 After Effects 发送给 Artisan。 |
| `PR_RenderContextH`        | 定义渲染内容和方式的设置集合。                          |
| `AEGP_SoundDataH`          | 用于给定图层的音频设置。                                |
| `AEGP_RenderReceiptH`      | 由 Artisan 在渲染时使用。                               |
| `AEGP_FrameReceiptH`       |                                                         |
| `AEGP_WorldH`              | 一帧像素。                                              |
| `AEGP_RenderOptionsH`      | 与渲染队列项相关的设置。                                |

---

## 水平还是垂直？

After Effects 的矩阵是基于行的；OpenGL 的矩阵是基于列的。这意味着你需要做更多的工作。耶，可计费的时间！

---

## 实现与设计

Artisan 几乎是一个独立的应用程序。因为在 After Effects 5.0 的早期阶段，我们就意识到 3D 渲染中存在许多问题需要解决；例如交叉和阴影。

我们提供了一个 API，使我们和第三方（是的，我们确实使用自己的 API）可以实现任何所需的 3D 渲染方案。

---

## 3D 合成，而非建模

After Effects **不是** 3D 建模应用程序。用户在响应模式下工作，仅在校对或最终输出时切换到更高质量。考虑提供至少两种质量模式，一种用于布局，另一种用于最终输出。在低质量模式下要注意渲染时间。

---

## 注册 Artisan

Artisan 是一个 AEGP，并且只有一个入口点。Artisan 还必须注册自己的函数入口点，并为此目的有一个特殊的回调。请参阅 [AEGP_RegisterSuites5](../aegps/aegp-suites.md#aegp_registersuites5) 中的 `AEGP_RegisterArtisan()`。

此表显示了 Artisan 可以支持的函数，由 `PR_ArtisanEntryPoints` 定义：只有 `render_func` 是必需的。

### Artisan 入口点

| PR_ArtisanEntryPoints        |                                                                                                                                                                                                                                                                                                                                                                                           |
| ---------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `global_setup_func0`       | 仅在 `GP_Main` 之后调用一次。全局数据在所有插件实例之间共享。                                                                                                                                                                                                                                                                                                                           |
|                              | 如果在全局设置期间分配了内存，则必须在 `global_setdown_func` 期间释放它。                                                                                                                                                                                                                                                                                                               |
|                              | `<pre lang="cpp">`PR_GlobalSetupFunc(``const PR_InData    \*in_dataP,``  PR_GlobalContextH  global_contextH,``  PR_GlobalDataH     \*global_dataPH);`</pre>`                                                                                                                                                                                                   |
| `global_setdown_func0`     | 释放你分配的任何全局数据。                                                                                                                                                                                                                                                                                                                                                                |
|                              | `<pre lang="cpp">`PR_GlobalSetdownFunc(``const PR_InData    \*in_dataP,``  PR_GlobalContextH  global_contextH,``  PR_GlobalDataH     global_dataH);`</pre>`                                                                                                                                                                                                    |
| `global_do_about_func0`    | 向世界介绍你自己！使用 `in_dataP>msg_func` 显示你的对话框。                                                                                                                                                                                                                                                                                                                             |
|                              | `<pre lang="cpp">`PR_GlobalDoAboutFunc(``const PR_InData    \*in_dataP,``  PR_GlobalContextH  global_contextH,``  PR_GlobalDataH     global_dataH);`</pre>`                                                                                                                                                                                                    |
| `setup_instance_func0`     | 分配并实例化此 Artisan 实例的特定数据。                                                                                                                                                                                                                                                                                                                                                   |
|                              | `<pre lang="cpp">`PR_InstanceSetupFunc(``const PR_InData      \*in_dataP,``  PR_GlobalContextH    global_contextH,``PR_InstanceContextH  instance_contextH,``  PR_GlobalDataH       global_dataH,``PR_InstanceFlags     flags,``  PR_FlatHandle        flat_dataH0,``  PR_InstanceDataH     \*instance_dataPH);`</pre>`        |
| `setdown_instance_func0`   | 释放并释放此 Artisan 实例的特定数据。                                                                                                                                                                                                                                                                                                                                                     |
|                              | `<pre lang="cpp">`PR_InstanceSetdownFunc(``const PR_InData      \*in_dataP,``  PR_GlobalContextH    global_contextH,``PR_InstanceContextH  instance_contextH,``  PR_GlobalDataH       global_dataH,``  PR_InstanceDataH     instance_dataH);`</pre>`                                                                                           |
| `flatten_instance_func0`   | 在准备写入磁盘时展平你的数据。（确保它是操作系统独立的，如果你的 Artisan 是）。                                                                                                                                                                                                                                                                                                           |
|                              | `<pre lang="cpp">`PR_FlattenInstanceFunc(``const PR_InData      \*in_dataP,``  PR_GlobalContextH    global_contextH,``PR_InstanceContextH  instance_contextH,``  PR_GlobalDataH       global_dataH,``PR_InstanceDataH     instance_dataH,``  PR_FlatHandle        \*flatH);`</pre>`                                                   |
| `do_instance_dialog_func0` | 如果你的 Artisan 有额外的参数（通过其选项对话框访问），将调用此函数来获取和设置它们。                                                                                                                                                                                                                                                                                                     |
|                              | `<pre lang="cpp">`PR_DoInstanceDialogFunc(``const PR_InData      \*in_dataP,``  PR_GlobalContextH    global_contextH,``PR_InstanceContextH  instance_contextH,``  PR_GlobalDataH       global_dataH,``PR_InstanceDataH     instance_dataH,``  PR_DialogResult      \*resultP);`</pre>`                                                |
|                              | `PR_DialogResultis` 是 `PR_DialogResult_NO_CHANGE` 或 `PR_DialogResult_CHANGE_MADE`。                                                                                                                                                                                                                                                                                               |
| `frame_setup_func0`        | 执行渲染帧所需的任何设置（在渲染之前立即调用）。                                                                                                                                                                                                                                                                                                                                          |
|                              | `<pre lang="cpp">`PR_FrameSetupFunc(``const PR_InData      \*in_dataP,``  PR_GlobalContextH    global_contextH,``PR_InstanceContextH  instance_contextH``  PR_RenderContextH    render_contextH,``PR_GlobalDataH       global_dataH,``  PR_InstanceDataH     instance_dataH,``  PR_RenderDataH       \*render_dataPH);`</pre>` |
| `frame_setdown_func0`      | 释放 `frame_setup` 期间分配的任何设置数据（在渲染后立即发送）。                                                                                                                                                                                                                                                                                                                         |
|                              | `<pre lang="cpp">`PR_FrameSetdownFunc(``const PR_InData      \*in_dataP,``  PR_GlobalContextH    global_contextH,``PR_InstanceContextH  instance_contextH``  PR_RenderContextH    render_contextH,``PR_GlobalDataH       global_dataH,``  PR_InstanceDataH     instance_dataH,``  PR_RenderDataH       render_dataH);`</pre>`  |
| `render_func`              | 渲染场景。                                                                                                                                                                                                                                                                                                                                                                                |
|                              | `<pre lang="cpp">`PR_FrameRenderFunc(``const PR_InData      \*in_dataP,``  PR_GlobalContextH    global_contextH,``PR_InstanceContextH  instance_contextH``  PR_RenderContextH    render_contextH,``PR_GlobalDataH       global_dataH,``  PR_InstanceDataH     instance_dataH,``  PR_RenderDataH       render_dataH);`</pre>`   |
| `query_func0`              | Artisan 可以绘制自己的投影轴，如果需要的话。                                                                                                                                                                                                                                                                                                                                              |
|                              | After Effects 将调用此函数以获取合成世界与这些轴之间的变换，以及与屏幕内外预览绘制相关的许多其他函数（前者仅与交互式 Artisan 相关）。                                                                                                                                                                                                                                                     |
|                              | `<pre lang="cpp">`PR_QueryFunc(``const PR_InData      \*in_dataP,``  PR_GlobalContextH    global_contextH,``PR_InstanceContextH  instance_contextH``  PR_QueryContextH     query_contextH,``PR_QueryType         query_type,``  PR_GlobalDataH       global_dataH,``  PR_InstanceDataH     instance_dataH);`</pre>`            |
|                              | `PR_QueryType` 可以是以下之一：                                                                                                                                                                                                                                                                                                                                                         |
|                              | -`PR_QueryType_NONE = 0`                                                                                                                                                                                                                                                                                                                                                                |
|                              | -`PR_QueryType_TRANSFORM`                                                                                                                                                                                                                                                                                                                                                               |
|                              | -`PR_QueryType_INTERACTIVE_WINDOW_DISPOSE`                                                                                                                                                                                                                                                                                                                                              |
|                              | -`PR_QueryType_INTERACTIVE_WINDOW_CLEAR`                                                                                                                                                                                                                                                                                                                                                |
|                              | -`PR_QueryType_INTERACTIVE_WINDOW_FROZEN_PROXY`                                                                                                                                                                                                                                                                                                                                         |
|                              | -`PR_QueryType_INTERACTIVE_SWAP_BUFFER`                                                                                                                                                                                                                                                                                                                                                 |
|                              | -`PR_QueryType_INTERACTIVE_DRAW_PROCS`                                                                                                                                                                                                                                                                                                                                                  |
|                              | -`PR_QueryType_PREPARE_FOR_LINE_DRAWING`                                                                                                                                                                                                                                                                                                                                                |
|                              | -`PR_QueryType_UNPREPARE_FOR_LINE_DRAWING`                                                                                                                                                                                                                                                                                                                                              |
|                              | -`PR_QueryType_GET_CURRENT_CONTEXT_SAFE_FOR_LINE_DRAWING`                                                                                                                                                                                                                                                                                                                               |
|                              | -`PR_QueryType_GET_ARTISAN_QUALITY` (CS6 新增)                                                                                                                                                                                                                                                                                                                                          |

---

## 世界是你的画布

`AEGP_RenderTexture()` 将图层的原始像素（未变换）提供到任意大小的缓冲区中。

`AEGP_RenderLayer()` 调用整个 After Effects 渲染管道，包括变换、遮罩等，提供图层在合成中的外观，并在合成大小的缓冲区中提供。

如果要渲染的图层是 3D 的，则调用默认的（标准 3D）Artisan 来执行任何 3D 几何操作。

你的 Artisan 可以使用它来渲染轨道遮罩图层，并仅以严格的 2D 方式将其应用于变换后的 3D 图层。

在渲染之前，After Effects 附带的 Artisan 会应用逆变换以获得方形像素，然后在显示之前重新应用变换。

例如，如果像素宽高比为 10/11（DV NTSC），我们乘以 11/10 以获得方形像素。我们处理和合成 3D 图层，然后重新除以以恢复原始像素宽高比。

以下套件提供了图层、合成、纹理和目标缓冲区。这是所有 Artisan 的重要套件。

### AEGP_CanvasSuite8

| 函数                                         | 用途                                                                                                                                                                                                                                                                                                                                                                               |
| -------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `AEGP_GetCompToRender`                     | 给定渲染时提供给 Artisan 的渲染上下文，返回合成的句柄。                                                                                                                                                                                                                                                                                                                            |
|                                              | `<pre lang="cpp">`AEGP_GetCompToRender(``PR_RenderContextH  render_contextH,``  AEGP_CompH         \*compPH)`</pre>`                                                                                                                                                                                                                                           |
| `AEGP_GetNumLayersToRender`                | 给定渲染上下文，返回 Artisan 需要渲染的图层数量。                                                                                                                                                                                                                                                                                                                                  |
|                                              | `<pre lang="cpp">`AEGP_GetNumLayersToRender(``PR_RenderContextH  render_contextH,``  A_long             \*num_to_renderPL)`</pre>`                                                                                                                                                                                                                             |
| `AEGP_GetNthLayerContextToRender`          | 用于在确定 Artisan 需要渲染的图层总数后，构建要渲染的图层列表。                                                                                                                                                                                                                                                                                                                    |
|                                              | `<pre lang="cpp">`AEGP_GetNthLayerContextToRender(``PR_RenderContextH         render_contextH,``  A_long                    n,``  AEGP_RenderLayerContextH  \*layer_indexPH)`</pre>`                                                                                                                                                                    |
| `AEGP_GetLayerFromLayerContext`            | 给定 `AEGP_RenderLayerContextH`，检索关联的 `AEGP_LayerH`（许多套件函数需要）。                                                                                                                                                                                                                                                                                                |
|                                              | `<pre lang="cpp">`AEGP_GetLayerFromLayerContext(``const PR_RenderContextH   render_contextH,``  AEGP_RenderLayerContextH  layer_contextH,``  AEGP_LayerH               \*layerPH);`</pre>`                                                                                                                                                              |
| `AEGP_GetLayerAndSubLayerFromLayerContext` | 允许渲染子图层（如 Photoshop 文件中的子图层）。                                                                                                                                                                                                                                                                                                                                    |
|                                              | `<pre lang="cpp">`AEGP_GetLayerAndSubLayerFromLayerContext(``const PR_RenderContextH   render_contextH,``  AEGP_RenderLayerContextH  layer_contextH,``AEGP_LayerH               \*layerPH,``  AEGP_SubLayerIndex        \*sublayerP);`</pre>`                                                                                                  |
| `AEGP_GetTopLayerFromLayerContext`         | 当折叠几何体“开启”时，这将给出包含图层上下文的根合成中的图层。                                                                                                                                                                                                                                                                                                                   |
|                                              | 当折叠几何体关闭时，这与 `AEGP_GetLayerFromLayerContext` 相同。                                                                                                                                                                                                                                                                                                                  |
|                                              | `<pre lang="cpp">`AEGP_GetTopLayerFromLayerContext(``const PR_RenderContextH   r_contextH,``  AEGP_RenderLayerContextH  l_contextH,``  AEGP_LayerH               \*layerPH);`</pre>`                                                                                                                                                                    |
| `AEGP_GetCompRenderTime`                   | 给定渲染上下文，返回要渲染的当前（合成）时间点。                                                                                                                                                                                                                                                                                                                                   |
|                                              | `<pre lang="cpp">`AEGP_GetNthLayerIndexToRender(``PR_RenderContextH  render_contextH,``  A_long             \*time,``  A_long             \*time_step)`</pre>`                                                                                                                                                                                          |
| `AEGP_GetCompDestinationBuffer`            | 给定渲染上下文，返回用于放置最终渲染输出的缓冲区。                                                                                                                                                                                                                                                                                                                                 |
|                                              | `<pre lang="cpp">`AEGP_GetCompToRender(``PR_RenderContextH  render_contextH,``  AEGP_CompH         compH,``  PF_EffectWorld     \*dst);`</pre>`                                                                                                                                                                                                         |
| `AEGP_GetROI`                              | 给定渲染时提供给 Artisan 的渲染上下文，返回合成的句柄。                                                                                                                                                                                                                                                                                                                            |
|                                              | `<pre lang="cpp">`AEGP_GetROI(``PR_RenderContextH  render_contextH,``  A_LegacyRect       \*roiPR);`</pre>`                                                                                                                                                                                                                                                    |
| `AEGP_RenderTexture`                       | 给定渲染上下文和图层，返回图层纹理。                                                                                                                                                                                                                                                                                                                                               |
|                                              | 所有带有尾随 '0' 的参数都是可选的；返回的 `PF_EffectWorld` 可以为 NULL。                                                                                                                                                                                                                                                                                                         |
|                                              | `<pre lang="cpp">`AEGP_RenderTexture(``PR_RenderContextH  render_contextH,``  AEGP_LayerH        layerH,``AEGP_RenderHints   render_hints,``  A_FloatPoint       \*suggested_scaleP0,``A_FloatRect        \*suggsted_src_rectP0,``  A_Matrix3          \*src_matrixP0,``  PF_EffectWorld     \*render_bufferP);`</pre>` |
|                                              | `AEGP_RenderHints` 包含以下一个或多个：                                                                                                                                                                                                                                                                                                                                          |
|                                              | -`AEGP_RenderHints_NONE`                                                                                                                                                                                                                                                                                                                                                         |
|                                              | -`AEGP_RenderHints_IGNORE_EXTENTS`                                                                                                                                                                                                                                                                                                                                               |
|                                              | - `AEGP_RenderHints                                                                                                                                                                                                                                                                                                                                                                |
